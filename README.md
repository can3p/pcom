# Pcom - private social network

Private as in the content is not public by default and discovery requires a human touch. Please refer to [manifesto](cmd/web/client/articles/why.md)
for more details.

Pcom uses [gogo](https://github.com/can3p/gogo) to handle forms and some other things!

If you want to follow the development, there is a [youtube playlist](https://www.youtube.com/playlist?list=PLa5K-kCUS-FozB6Cw7rJLFJaxyZd-MPpi) with demos!

## Dependencies

* libvips (`brew install vips pkg-config`)

## Dev Setup

* Install go, asdf, postgres, watchexec
* `asdf install`
* `npm install -g yarn`
* `cd cmd/web; yarn install`
* `go install github.com/rubenv/sql-migrate/...@latest`
* `go install github.com/volatiletech/sqlboiler/v4@latest`
* `go install github.com/volatiletech/sqlboiler/v4/drivers/sqlboiler-psql@latest`
* `createuser pcom -W` use `pcom` as a password there
* `createdb --owner=pcom pcom_dev`
* `echo 'SESSION_SALT=random' >> cmd/web/.env`
* `echo 'SITE_ROOT=http://localhost:8000' >> cmd/web/.env`
* `echo 'DATABASE_URL=postgres://pcom:pcom@localhost:5432/pcom_dev?sslmode=disable' >> cmd/web/.env`
* `./sqlmigrate up`

### Run the frontend

```
cd cmd/web; yarn watch
```

### Run the server

```
cd cmd/web; make watchexec
```

### psql access

```
psql -U pcom pcom_dev
```

### schema changes

```
./sql-migrate new migration_name
```

Edit the file given by sql-migrate

```
./sql-migrate up
```

```
./generate.sh
```

## Initial Setup

1. change remote and push to the new repo
2. change flytoml to point to the new app pcom
3. create the app on fly `flyctl apps create pcom`
4. create db, set 4gb ram `fly postgres create -n pcomdb`
5. attach db to the app `flyctl postgres attach -a pcom pcomdb`
6. Set secrets:

   ```
   flyctl secrets set SESSION_SALT=<random string>
   flyctl secrets set SITE_ROOT=https://pcom.com
   flyctl secrets set MJ_APIKEY_PUBLIC=<public key from mailjet>
   flyctl secrets set MJ_APIKEY_PRIVATE=<private key from mailjet>
   # this one should include scheme
   flyctl secrets set USER_MEDIA_ENDPOINT=<endpoint>
   flyctl secrets set USER_MEDIA_BUCKET=<bucket>
   flyctl secrets set USER_MEDIA_KEY=<key>
   flyctl secrets set USER_MEDIA_REGION=<region>
   flyctl secrets set USER_MEDIA_SECRET=<secret>
   flyctl secrets set SENDER_ADDRESS=<address>
   flyctl secrets set ADMIN_ADDRESS=<address>
   flyctl secrets set STATIC_CDN=<address> # in case you want to put static resources behind the cdn
   flyctl secrets set USER_MEDIA_CDN=<address> # in case you want to put user images behind the cdn

   ```
6. Before
7. Do first deploy `fly deploy`, make sure you can reach the app via <appname>.fly.dev
8. Create a cert for your custom domain `fly certs add pcom.com`
9. After it screams at you, add required A and AAAA records
10. You might need to run `fly certs check pcom.com` a couple of times, `fly certs list` should show your domain with the status `ready`.
11. You should be able to reach your app via custom domain at this point
12. Got to mailjet and add new domain
13. Add sender email address there
14. Add required txt record to validate domain
15. Add required txt records to add DKIM and SPF settings
16. Add postgres db env var to `cmd/web/.env` via `./env.pl > cmd/web/.env`, remove `sslmode=disable` and replace domain name with localhost
18. Run the following from the project root to get the database schema in place

Tab 1:

```
fly proxy 5433:5432 -a pcomdb
```

Tab 2

```
./run.sh
./sqlmigrate.sh up
```

## Development

```
cd cmd/web
yarn
yarn watch # in one tab
make watchexec # in another tab
```

## Operational notes

* App instance is running in a wrong dc:

  ```
  fly scale count 0
  fly scale count 1 --region ams
  ```

## Credits

The project has been generated by [gogo-cli](https://github.com/can3p/gogo-cli) and uses [gogo](https://github.com/can3p/gogo) library
